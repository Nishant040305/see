#!/usr/bin/env python3
"""
SEE - CLI Command Helper
Main entry point for the application.
"""

import sys
from pathlib import Path

# Import from same directory
from config import COMMANDS_FILE
from storage import CommandStorage
from manager import CommandManager
from executor import CommandExecutor
from printer import CommandPrinter
from cli import CLI
from parser import create_parser, parse_add_syntax, print_help
from installer import handle_install


def main():
    """Main entry point."""
    # Initialize components
    storage = CommandStorage(COMMANDS_FILE)
    manager = CommandManager(storage)
    executor = CommandExecutor()
    printer = CommandPrinter()
    cli = CLI(manager, executor, printer)
    
    # Check if this is a subcommand
    subcommands = ['search', 'list', 'show', 'run', 'delete', 'stats', 'install', 'edit', 'tags', 'interactive', 'i', 'import']
    
    if len(sys.argv) > 1 and sys.argv[1] in subcommands:
        # Handle subcommands
        parser = create_parser()
        args = parser.parse_args()
        
        if args.command == 'search':
            query = ' '.join(args.query) if args.query else None
            cli.handle_search(query=query, tags=args.tags)
        elif args.command == 'list':
            cli.handle_list(tags=args.tags, limit=args.limit, sort=args.sort)
        elif args.command == 'show':
            cli.handle_show(args.id, copy_to_clipboard=args.copy)
        elif args.command == 'run':
            cli.handle_run(args.id, dry_run=args.dry_run, shell_mode=not args.verbose, args=args.args)
        elif args.command == 'delete':
            cli.handle_delete(args.id)
        elif args.command == 'edit':
            cli.handle_edit(args.id, description=args.description, tags=args.tags)
        elif args.command == 'tags':
            cli.handle_tags()
        elif args.command == 'stats':
            cli.handle_stats()
        elif args.command in ['interactive', 'i']:
            cli.handle_interactive(shell_mode=True)
        elif args.command == 'import':
            cli.handle_import(
                from_history=args.history,
                lines=args.lines,
                file_path=args.file,
                no_filter=args.no_filter
            )
        elif args.command == 'install':
            # Get the path to this script for the installer
            script_path = str(Path(__file__).resolve())
            handle_install(args.shell, script_path)
    else:
        # Parse add syntax
        result = parse_add_syntax(sys.argv[1:])
        if result is None:
            print_help(file=sys.stderr)
        elif result.get('help'):
            print_help()
        else:
            cli.handle_add(
                description=result['description'],
                tags=result['tags'],
                command=result['command'],
                save_only=result['save_only'],
                silent=True,
                shell_mode=result.get('shell_mode', False)
            )


if __name__ == '__main__':
    main()
